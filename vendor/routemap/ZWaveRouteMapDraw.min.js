window.ZWaveRoutesPlotLib=function(){function f(c,b,l,e,f,g){g||(g=function(c){return c});return g((c-b)/(l-b))*(f-e)+e}function u(c,b,e){c=("00"+Math.round(f(c,b,e,64,255,Math.sqrt)).toString(16)).slice(-2);b=("00"+(64).toString(16)).slice(-2);return"#"+c+b+b}function z(c){switch(c){case "Controller":return b.color.controller;case "FLiRS":return b.color.flirs;case "Sleeping":return b.color.sleeping;case "Routing":return b.color.routing;default:throw"Unknow type:"+c;}}function e(b){this.zna=b;this.data=
{nodes:this.zna.getNodes(),links:this.zna.getLinks()};this.selectedNode=null;this.initPlot();this.initNodes();this.nodesMoveAllowed=!1}var b={color:{selected:"darkred",current:"coral",routedFor:"sandybrown",association:"red",controller:"lightgray",flirs:"darkgreen",sleeping:"lightblue",routing:"black"},status:{dead:"Node is dead",alive:"Node is alive"},routes:{othersOpacity:"0.3"},viewport:{sizeX:200,sizeY:100}};e.prototype.initPlot=function(){var b=d3.select("#svg");b.append("rect").style("fill",
"none").style("pointer-events","all");this.chartLayer=b.append("g").classed("chartLayer",!0).attr("width",1).attr("height",1).attr("transform","translate(0,0)")};e.prototype.initNodes=function(){function c(a){t();null===d.selectedNode?m(a):v(a);if(null===d.selectedNode||d.selectedNode===a)d3.select("#ShowRepeatingFor").node().checked&&A(a.id),d3.select("#ShowNeighbours").node().checked&&w(a.id);else{B(d.selectedNode.id,a.id);var c=d.selectedNode.id,e=a.id;if(c==d.zna.getMyNodeId()){var h=d.zna.getTrajectoryStats(c,
e),c=d.zna.getTrajectoryStats(e,c);console.log(c);d3.select("#annotation-src-dst-n-reroutes").html(Math.round(100*h.retries)/100);d3.select("#annotation-src-dst-num-hops").html(h.minOutHops!==h.maxOutHops?h.minOutHops+"&ndash;"+h.maxOutHops:h.minOutHops);d3.select("#annotation-dst-src-explore-frames").html(Math.round(100*c.explores)/100)}}d3.selectAll('circle[id="id'+a.id+'"]').attr("fill",b.color.current);x();d3.select("#ShowAssociations").node().checked&&C(a.id)}function e(a){t();null!==d.selectedNode&&
w(d.selectedNode);D();x();m(d.selectedNode);v()}function l(a){d.selectedNode=d.selectedNode===a?null:a;m(d.selectedNode)}function q(a){d.nodesMoveAllowed&&(d3.event.active||n.alphaTarget(1).restart(),a.fx=a.x,a.fy=a.y)}function r(a){d.nodesMoveAllowed&&(a.fx=d3.event.x,a.fy=d3.event.y)}function g(a){d.nodesMoveAllowed&&(d3.event.active||n.alphaTarget(0),a.fx=null,a.fy=null)}function t(){d3.selectAll("line").attr("stroke",function(a){return u(a.rssi12,0,1)}).attr("stroke-width",function(a){return f(a.usage12,
0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",d3.select("#ShowAllRoutes").node().checked?b.routes.othersOpacity:"0")}function w(a){d3.selectAll('line[id1="'+a+'"]').attr("opacity","1");d3.selectAll('line[id2="'+a+'"]').attr("opacity","1")}function B(a,b){var c=d.zna.getTrajectoryLinkMap(a,b);d3.selectAll("line").attr("stroke",function(a){return u(a.rssi12,0,1)}).attr("stroke-width",function(a){a=c.usage(a.source.id,a.target.id)+
c.usage(a.target.id,a.source.id);return f(a,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",function(a){return c.usage(a.source.id,a.target.id)+c.usage(a.target.id,a.source.id)?"1":"0"})}function D(){d3.selectAll("circle").attr("fill",function(a){return a.color}).attr("stroke",function(a){return a.color}).attr("stroke-width","0px")}function x(){null!==d.selectedNode&&d3.selectAll('circle[id="id'+d.selectedNode.id+'"]').attr("fill",
b.color.selected)}function A(a){var c=d.zna.getNodesRoutedFor(a);d3.selectAll("circle").attr("fill",function(a){return-1!==c.indexOf(a.id)?b.color.routedFor:a.color})}function C(a){d3.selectAll("circle").filter(function(b){return-1!==d.zna.getNodeAssociations(a).indexOf(b.id)}).attr("stroke",b.color.association).attr("stroke-width",.2)}function m(a){d3.select("#annotation-src-id").html(a?a.id:"");d3.select("#annotation-src-name").html(a?a.name:"");d3.select("#annotation-src-type").html(a?a.type:"");
d3.select("#annotation-src-dead").html(a?a.dead?b.status.dead:b.status.alive:"");d3.select("#annotation-src-associations").html(a?d.zna.getNodeAssociations(a.id).join(", "):"");d3.select("#annotation-src-routes-for").html(a?d.zna.getNodesRoutedFor(a.id).join(", "):"")}function v(a){d3.select("#annotation-dst-id").html(a?a.id:"");d3.select("#annotation-dst-name").html(a?a.name:"");d3.select("#annotation-dst-type").html(a?a.type:"");d3.select("#annotation-dst-dead").html(a?a.dead?b.status.dead:b.status.alive:
"")}var d=this,n=d3.forceSimulation(this.data.nodes).force("linkForce",d3.forceLink(this.data.links).id(function(a){return a.id}).distance(function(a){return 400}).strength(0));this.data.nodes.map(function(a){a.r=f(a.usage,0,1,15,50,Math.sqrt)/8;a.color=z(a.type)});var k=this.data.nodes.filter(function(a){return null===a.x||null===a.y});if(1===k.length)k[0].x=b.viewport.sizeX/2,k[0].y=b.viewport.sizeY/2;else{var y=Math.min(b.viewport.sizeX,b.viewport.sizeY)/3,p=0;k.forEach(function(a){a.id===d.zna.getMyNodeId()?
a.x=a.y=0:(a.x=y*Math.cos(2*Math.PI/(k.length-1)*p),a.y=y*Math.sin(2*Math.PI/(k.length-1)*p),p++);a.x+=b.viewport.sizeX/2;a.y+=b.viewport.sizeY/2})}var E=this.chartLayer.append("g").attr("class","links").selectAll("line").data(this.data.links).enter().append("line").attr("id1",function(a){return a.source.id}).attr("id2",function(a){return a.target.id}),F=this.chartLayer.append("g").attr("class","nodes").selectAll("circle").data(this.data.nodes).enter().append("circle").attr("id",function(a){return"id"+
a.id}).attr("r",function(a){return a.r}).attr("fill",function(a){return a.color}).attr("mask",function(a){return a.dead?"url(#mask)":""}).call(d3.drag().on("start",q).on("drag",r).on("end",g)).on("mouseover",c).on("mouseout",e).on("click",l),G=this.chartLayer.append("g").attr("class","labels").selectAll("text").data(this.data.nodes).enter().append("text").text(function(a){return a.id}).attr("font-size",2).attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("transform",
function(a){return"translate(0,0)"}).call(d3.drag().on("start",q).on("drag",r).on("end",g)).on("mouseover",c).on("mouseout",e).on("click",l);n.on("tick",function(){E.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});F.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});G.attr("x",function(a){return a.x}).attr("y",function(a){return a.y})})};e.prototype.allowMoveNodes=
function(b){void 0!=b&&(this.nodesMoveAllowed=!this.nodesMoveAllowed);return this.nodesMoveAllowed};e.prototype.getNodesPositions=function(){return this.data.nodes.map(function(b){return{id:b.id,x:b.x,y:b.y}})};return e}();window.ZWaveRoutesPlotLib.prototype.getNodesPositions=window.ZWaveRoutesPlotLib.prototype.getNodesPositions;window.ZWaveRoutesPlotLib.prototype.allowMoveNodes=window.ZWaveRoutesPlotLib.prototype.allowMoveNodes;